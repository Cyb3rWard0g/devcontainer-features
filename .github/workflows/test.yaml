name: CI â€“ Feature Tests
on:
  pull_request:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  BASE_IMAGES: |
    debian:latest
    ubuntu:latest
    mcr.microsoft.com/devcontainers/base:ubuntu

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      list: ${{ steps.collect.outputs.features }}
    steps:
      - uses: actions/checkout@v4
      - name: Install jq
        run: apt-get update && apt-get install -y jq || true
      - id: collect
        run: |
          echo "features=$(ls -1 src | jq -R -s -c 'split("\n")[:-1]')" >> "$GITHUB_OUTPUT"

  autogenerated:
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        feature: ${{ fromJson(needs.discover.outputs.list) }}
        image:   [ ${{ env.BASE_IMAGES }} ]
    steps:
      - uses: actions/checkout@v4
      - name: Install devcontainer CLI
        uses: actions/setup-node@v4
        with: { node-version: 20, cache: 'npm' }
      - run: npm install -g @devcontainers/cli
      - name: Test feature against base image
        run: devcontainer features test -f ${{ matrix.feature }} -i ${{ matrix.image }} .

  scenario:
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        feature: ${{ fromJson(needs.discover.outputs.list) }}
    steps:
      - uses: actions/checkout@v4
      - name: Install devcontainer CLI
        uses: actions/setup-node@v4
        with: { node-version: 20, cache: 'npm' }
      - run: npm install -g @devcontainers/cli
      - name: Test feature scenarios
        run: devcontainer features test -f ${{ matrix.feature }} --skip-autogenerated --skip-duplicated .

  global:
    if: ${{ hashFiles('test/global-scenarios/**') != '' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install devcontainer CLI
        uses: actions/setup-node@v4
        with: { node-version: 20, cache: 'npm' }
      - run: npm install -g @devcontainers/cli
      - name: Test global scenarios
        run: devcontainer features test --global-scenarios-only .